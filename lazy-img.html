<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../poly-poly/poly-poly.html">

<!--
`lazy-img`
Lazy loading img element, delays loading images until they come into the viewport

@demo demo/index.html
-->

<dom-module id="lazy-img">
  <template>
    <style>
      :host {
        display: inline-block;
        overflow: hidden;
        position: relative;
      }

      img {
        display: block;
        width: var(--lazy-img-width, auto);
        height: var(--lazy-img-height, auto);
        @apply(--lazy-img);
      }

      img.loaded {
        @apply(--lazy-img-loaded);
      }
    </style>
    <img id="img" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="[[alt]]">
  </template>

  <script>
    (function() {
      'use strict';

      var polypoly = /** @type {!PolyPolyElement} */ document.createElement('poly-poly');

      // We need the IntersectionObserver outside of the element so we
      // wrap and delay the entire definition based on the promise in
      // case it's being polyfilled asynchronously. If we only needed
      // the promise within our element, we'd likely use the behavior
      // version instead.
      polypoly.completes.then(function() {

        var observer = new IntersectionObserver(function(entries){
          for(var i = 0; i < entries.length; i++) {
            entries[i].target._load();
          }
        });

        Polymer({
          is: 'lazy-img',

          properties: {
            /** The source URL for the image */
            src: {
              type: String
            },

            /** The alt attribute for the image */
            alt: {
              type: String
            }
          },

          _load: function() {
            var img = this.$.img;
            img.onload = function() {
              img.classList.add('loaded');
            };
            img.src = this._resolveSrc(this.src);

            // stop observing once loaded
            observer.unobserve(this);
          },

          _resolveSrc: function(testSrc) {
            var baseURI = /** @type {string} */(this.ownerDocument.baseURI);
            return (new URL(Polymer.ResolveUrl.resolveUrl(testSrc, baseURI), baseURI)).href;
          },

          attached: function() {
            observer.observe(this);
          },

          detached: function() {
            observer.unobserve(this);
          }
        });

      }).catch(function(err) {
        console.log('error loading polyfills, IntersectionObserver may not be available')
      });
    })();
  </script>
</dom-module>
